# AIæƒ…ç»ªæ—¥è®° - æ‰‹åŠ¨éƒ¨ç½²æŒ‡å—

ç”±äºGitHub Actionsç½‘ç»œä¸ç¨³å®šï¼Œæˆ‘ä»¬æä¾›äº†å®Œæ•´çš„æ‰‹åŠ¨éƒ¨ç½²è§£å†³æ–¹æ¡ˆã€‚

## ğŸ¯ éƒ¨ç½²æ–¹æ¡ˆæ¦‚è¿°

æˆ‘ä»¬æä¾›äº†3ä¸ªè„šæœ¬æ¥æ»¡è¶³ä¸åŒçš„éƒ¨ç½²éœ€æ±‚ï¼š

1. **`scripts/setup-server.sh`** - æœåŠ¡å™¨ç¯å¢ƒé…ç½® (ä¸€æ¬¡æ€§)
2. **`scripts/manual-deploy.sh`** - å®Œæ•´æ‰‹åŠ¨éƒ¨ç½² (é¦–æ¬¡éƒ¨ç½²)
3. **`scripts/quick-deploy.sh`** - å¿«é€Ÿä»£ç æ›´æ–° (æ—¥å¸¸æ›´æ–°)

## ğŸ“‹ å‰ç½®æ¡ä»¶

### æœ¬åœ°ç¯å¢ƒ
- macOS/Linuxç³»ç»Ÿ
- SSHå®¢æˆ·ç«¯
- rsyncå·¥å…· (æ¨è)
- å·²é…ç½®çš„SSHå¯†é’¥

### é˜¿é‡Œäº‘ECSæœåŠ¡å™¨
- Ubuntu 18.04+ æˆ– CentOS 7+
- å¼€æ”¾ç«¯å£ï¼š22 (SSH), 80 (HTTP), 443 (HTTPS), 8000 (Django)
- sudoæƒé™

## ğŸš€ éƒ¨ç½²æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šé…ç½®æœåŠ¡å™¨ç¯å¢ƒ

é¦–å…ˆéœ€è¦åœ¨ECSæœåŠ¡å™¨ä¸Šé…ç½®è¿è¡Œç¯å¢ƒï¼š

```bash
# 1. SSHç™»å½•åˆ°ECSæœåŠ¡å™¨
ssh -i ~/.ssh/emotion-diary-deploy root@YOUR_ECS_IP

# 2. ä¸‹è½½å¹¶è¿è¡Œç¯å¢ƒé…ç½®è„šæœ¬
curl -O https://raw.githubusercontent.com/Nightwatcher1982/emotion-diary/main/scripts/setup-server.sh
chmod +x setup-server.sh
./setup-server.sh
```

è¯¥è„šæœ¬ä¼šè‡ªåŠ¨å®‰è£…ï¼š
- âœ… Python 3.9+
- âœ… Node.js 18+
- âœ… Git, rsyncç­‰åŸºç¡€å·¥å…·
- âœ… MySQL (å¯é€‰)
- âœ… Nginx (å¯é€‰)
- âœ… é˜²ç«å¢™é…ç½®
- âœ… systemdæœåŠ¡é…ç½®

### ç¬¬äºŒæ­¥ï¼šé¦–æ¬¡éƒ¨ç½²é¡¹ç›®

åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•è¿è¡Œï¼š

```bash
# ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
cd /path/to/emotion-diary

# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x scripts/manual-deploy.sh

# è¿è¡Œå®Œæ•´éƒ¨ç½²
./scripts/manual-deploy.sh
```

è„šæœ¬ä¼šæç¤ºä½ è¾“å…¥ï¼š
- ECSæœåŠ¡å™¨IPåœ°å€
- SSHç”¨æˆ·å (é»˜è®¤: root)
- SSHå¯†é’¥è·¯å¾„ (é»˜è®¤: ~/.ssh/emotion-diary-deploy)

éƒ¨ç½²è¿‡ç¨‹åŒ…æ‹¬ï¼š
1. ğŸ” æ£€æŸ¥æœ¬åœ°ç¯å¢ƒå’ŒSSHè¿æ¥
2. ğŸ” æ£€æŸ¥æœåŠ¡å™¨ç¯å¢ƒå’Œå·¥å…·
3. ğŸ“¦ æ‰“åŒ…æœ¬åœ°ä»£ç 
4. ğŸ“¤ ä¸Šä¼ åˆ°æœåŠ¡å™¨
5. ğŸ”§ åœ¨æœåŠ¡å™¨ä¸Šé…ç½®Pythonç¯å¢ƒ
6. ğŸ“± æ„å»ºå‰ç«¯ (å¦‚æœæœ‰Node.js)
7. âœ… éªŒè¯éƒ¨ç½²ç»“æœ

### ç¬¬ä¸‰æ­¥ï¼šæ—¥å¸¸æ›´æ–° (å¿«é€Ÿéƒ¨ç½²)

æ—¥å¸¸å¼€å‘ä¸­ï¼Œåªéœ€è¦åŒæ­¥ä»£ç æ›´æ”¹ï¼š

```bash
# å¿«é€ŸåŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨
./scripts/quick-deploy.sh
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- ğŸ“¤ ä½¿ç”¨rsyncå¿«é€ŸåŒæ­¥ä»£ç 
- ğŸ”„ è‡ªåŠ¨é‡å¯åç«¯æœåŠ¡
- âš¡ é€Ÿåº¦æ›´å¿«ï¼Œé€‚åˆé¢‘ç¹æ›´æ–°

## ğŸ”§ é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡é…ç½®

ä½ å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡é¢„è®¾é…ç½®ï¼Œé¿å…æ¯æ¬¡è¾“å…¥ï¼š

```bash
# åœ¨ ~/.bashrc æˆ– ~/.zshrc ä¸­æ·»åŠ ï¼š
export SERVER_HOST="YOUR_ECS_IP"
export SERVER_USER="root"
export SSH_KEY_PATH="$HOME/.ssh/emotion-diary-deploy"

# é‡æ–°åŠ è½½é…ç½®
source ~/.bashrc
```

### SSHå¯†é’¥é…ç½®

å¦‚æœè¿˜æ²¡æœ‰SSHå¯†é’¥ï¼Œå¯ä»¥ç”Ÿæˆï¼š

```bash
# ç”ŸæˆSSHå¯†é’¥å¯¹
ssh-keygen -t rsa -b 4096 -C "emotion-diary-deploy" -f ~/.ssh/emotion-diary-deploy

# å°†å…¬é’¥æ·»åŠ åˆ°æœåŠ¡å™¨
ssh-copy-id -i ~/.ssh/emotion-diary-deploy.pub root@YOUR_ECS_IP
```

## ğŸ“Š éƒ¨ç½²éªŒè¯

### æ£€æŸ¥éƒ¨ç½²ç»“æœ

```bash
# SSHç™»å½•æœåŠ¡å™¨
ssh -i ~/.ssh/emotion-diary-deploy root@YOUR_ECS_IP

# æ£€æŸ¥é¡¹ç›®æ–‡ä»¶
cd ~/emotion-diary
ls -la

# æ£€æŸ¥Pythonç¯å¢ƒ
cd backend
source venv/bin/activate
python --version
pip list

# æ£€æŸ¥å‰ç«¯æ„å»º
cd ../frontend
ls -la dist/

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
ps aux | grep python
```

### å¯åŠ¨æœåŠ¡

```bash
# æ‰‹åŠ¨å¯åŠ¨DjangoæœåŠ¡
cd ~/emotion-diary/backend
source venv/bin/activate
python manage.py runserver 0.0.0.0:8000

# æˆ–ä½¿ç”¨systemdæœåŠ¡ (å¦‚æœå·²é…ç½®)
sudo systemctl start emotion-diary
sudo systemctl status emotion-diary
```

### è®¿é—®æµ‹è¯•

```bash
# æµ‹è¯•åç«¯API
curl http://YOUR_ECS_IP:8000/

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://YOUR_ECS_IP:8000/health/
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **SSHè¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥SSHå¯†é’¥æƒé™
   chmod 600 ~/.ssh/emotion-diary-deploy
   
   # æµ‹è¯•SSHè¿æ¥
   ssh -i ~/.ssh/emotion-diary-deploy -v root@YOUR_ECS_IP
   ```

2. **rsyncå¤±è´¥**
   ```bash
   # å¦‚æœrsyncä¸å¯ç”¨ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ä½¿ç”¨scp
   # æ‰‹åŠ¨å®‰è£…rsync:
   sudo apt-get install rsync  # Ubuntu
   sudo yum install rsync      # CentOS
   ```

3. **Pythonä¾èµ–å®‰è£…å¤±è´¥**
   ```bash
   # åœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨å®‰è£…
   cd ~/emotion-diary/backend
   source venv/bin/activate
   pip install --upgrade pip
   pip install -r requirements.txt
   ```

4. **å‰ç«¯æ„å»ºå¤±è´¥**
   ```bash
   # æ£€æŸ¥Node.jsç‰ˆæœ¬
   node --version  # éœ€è¦ >= 18.0
   
   # æ¸…ç†å¹¶é‡æ–°å®‰è£…
   cd ~/emotion-diary/frontend
   rm -rf node_modules package-lock.json
   npm install
   npm run build:mp-weixin
   ```

### æ—¥å¿—æ£€æŸ¥

```bash
# æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
tail -f ~/emotion-diary/logs/backend.log

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
sudo journalctl -u emotion-diary -f

# æŸ¥çœ‹Nginxæ—¥å¿— (å¦‚æœä½¿ç”¨)
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

## ğŸ”„ ç”Ÿäº§ç¯å¢ƒé…ç½®

### Nginxåå‘ä»£ç†é…ç½®

```nginx
# /etc/nginx/sites-available/emotion-diary
server {
    listen 80;
    server_name YOUR_DOMAIN_OR_IP;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location /static/ {
        alias /home/root/emotion-diary/backend/static/;
    }
    
    location /media/ {
        alias /home/root/emotion-diary/backend/media/;
    }
}
```

å¯ç”¨é…ç½®ï¼š
```bash
sudo ln -s /etc/nginx/sites-available/emotion-diary /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### SSLè¯ä¹¦é…ç½®

```bash
# å®‰è£…Certbot
sudo apt-get install certbot python3-certbot-nginx

# è·å–SSLè¯ä¹¦
sudo certbot --nginx -d YOUR_DOMAIN

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ : 0 12 * * * /usr/bin/certbot renew --quiet
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–

```bash
# MySQLé…ç½®ä¼˜åŒ–
sudo mysql_secure_installation

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
mysql -u root -p
CREATE DATABASE emotion_diary CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'emotion_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON emotion_diary.* TO 'emotion_user'@'localhost';
FLUSH PRIVILEGES;
```

### ç¼“å­˜é…ç½®

```bash
# å®‰è£…Redis (å¯é€‰)
sudo apt-get install redis-server
sudo systemctl start redis
sudo systemctl enable redis
```

## ğŸ‰ æ€»ç»“

æ‰‹åŠ¨éƒ¨ç½²æ–¹æ¡ˆçš„ä¼˜åŠ¿ï¼š

- âœ… **ä¸ä¾èµ–GitHub Actions** - é¿å…ç½‘ç»œé—®é¢˜
- âœ… **å®Œå…¨å¯æ§** - æ¯ä¸ªæ­¥éª¤éƒ½å¯ä»¥æ‰‹åŠ¨éªŒè¯
- âœ… **å¿«é€Ÿæ›´æ–°** - æ—¥å¸¸å¼€å‘ä½¿ç”¨å¿«é€Ÿéƒ¨ç½²
- âœ… **ç”Ÿäº§å°±ç»ª** - åŒ…å«Nginxã€SSLç­‰ç”Ÿäº§é…ç½®
- âœ… **æ•…éšœæ’é™¤** - è¯¦ç»†çš„æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯

ç°åœ¨ä½ å¯ä»¥å®Œå…¨è„±ç¦»GitHub Actionsï¼Œä½¿ç”¨ç¨³å®šçš„æ‰‹åŠ¨éƒ¨ç½²æ–¹æ¡ˆï¼ğŸš€ 