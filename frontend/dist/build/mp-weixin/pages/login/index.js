"use strict";const e=require("../../common/vendor.js"),n=require("../../utils/api.js"),o={data:()=>({phoneForm:{phone:"",code:"",nickname:""},isPhoneLogging:!1,isWechatLogging:!1,isSendingSMS:!1,smsCountdown:0,isDevelopment:!1,debugInfo:""}),computed:{canSendSMS(){return 11===this.phoneForm.phone.length&&/^1[3-9]\d{9}$/.test(this.phoneForm.phone)},canPhoneLogin(){return this.canSendSMS&&6===this.phoneForm.code.length},getSMSButtonText(){return this.isSendingSMS?"发送中...":this.smsCountdown>0?`${this.smsCountdown}s`:"获取验证码"}},methods:{onPhoneInput(e){this.phoneForm.phone=e.detail.value.replace(/\D/g,"")},async sendSMS(){if(this.canSendSMS&&!this.isSendingSMS){this.isSendingSMS=!0,this.debugInfo="正在发送验证码...";try{const o=await n.authAPI.sendSMS({phone:this.phoneForm.phone,purpose:"login"});e.index.showToast({title:"验证码发送成功",icon:"success"}),o.code&&this.isDevelopment?(this.debugInfo=`验证码: ${o.code}`,this.phoneForm.code=o.code):this.debugInfo="请查收短信验证码",this.startCountdown()}catch(o){console.error("发送验证码失败:",o),this.debugInfo=`发送失败: ${o.message}`,e.index.showToast({title:o.message||"验证码发送失败",icon:"none"})}finally{this.isSendingSMS=!1}}},startCountdown(){this.smsCountdown=60;const e=setInterval(()=>{this.smsCountdown--,this.smsCountdown<=0&&clearInterval(e)},1e3)},async handlePhoneLogin(){if(this.canPhoneLogin&&!this.isPhoneLogging){this.isPhoneLogging=!0,this.debugInfo="正在验证登录...";try{const o=await n.authAPI.phoneLogin({phone:this.phoneForm.phone,code:this.phoneForm.code,nickname:this.phoneForm.nickname});n.setToken(o.token),n.setUser(o.user),this.debugInfo="登录成功! "+(o.is_new_user?"(新用户)":"(老用户)"),e.index.showToast({title:o.is_new_user?"注册成功":"登录成功",icon:"success"}),setTimeout(()=>{e.index.switchTab({url:"/pages/index/index"})},1500)}catch(o){console.error("手机登录失败:",o),this.debugInfo=`登录失败: ${o.message}`,e.index.showToast({title:o.message||"登录失败",icon:"none"})}finally{this.isPhoneLogging=!1}}},async handleWechatLogin(){if(!this.isWechatLogging){this.isWechatLogging=!0,this.debugInfo="正在微信登录...";try{if(this.isDevelopment){const o=`mock_code_${Date.now()}`,i=await n.authAPI.wechatLogin({code:o,nickname:"微信用户",gender:"unknown"});n.setToken(i.token),n.setUser(i.user),this.debugInfo="微信登录成功! "+(i.is_new_user?"(新用户)":"(老用户)"),e.index.showToast({title:i.is_new_user?"注册成功":"登录成功",icon:"success"}),setTimeout(()=>{e.index.switchTab({url:"/pages/index/index"})},1500)}else e.index.showToast({title:"微信登录功能开发中",icon:"none"})}catch(o){console.error("微信登录失败:",o),this.debugInfo=`微信登录失败: ${o.message}`,e.index.showToast({title:o.message||"微信登录失败",icon:"none"})}finally{this.isWechatLogging=!1}}},fillTestPhone(){this.phoneForm.phone="13800138000",this.phoneForm.nickname="测试用户"},mockWechatLogin(){this.handleWechatLogin()},showPrivacyPolicy(){e.index.showModal({title:"用户协议与隐私政策",content:"我们承诺保护您的隐私，所有情绪数据仅用于个人分析，不会与第三方分享。",showCancel:!1})}}};const i=e._export_sfc(o,[["render",function(n,o,i,s,t,h){return e.e({a:e.o([e=>t.phoneForm.phone=e.detail.value,(...e)=>h.onPhoneInput&&h.onPhoneInput(...e)]),b:t.phoneForm.phone,c:t.phoneForm.phone?1:"",d:t.phoneForm.code,e:e.o(e=>t.phoneForm.code=e.detail.value),f:e.t(h.getSMSButtonText),g:!h.canSendSMS||t.smsCountdown>0?1:"",h:t.isSendingSMS?1:"",i:e.o((...e)=>h.sendSMS&&h.sendSMS(...e)),j:!h.canSendSMS||t.smsCountdown>0||t.isSendingSMS,k:t.phoneForm.code?1:"",l:t.phoneForm.nickname,m:e.o(e=>t.phoneForm.nickname=e.detail.value),n:t.phoneForm.nickname?1:"",o:e.t(t.isPhoneLogging?"登录中...":"手机号登录"),p:t.isPhoneLogging?1:"",q:e.o((...e)=>h.handlePhoneLogin&&h.handlePhoneLogin(...e)),r:!h.canPhoneLogin||t.isPhoneLogging,s:e.t(t.isWechatLogging?"登录中...":"微信登录"),t:t.isWechatLogging?1:"",v:e.o((...e)=>h.handleWechatLogin&&h.handleWechatLogin(...e)),w:t.isWechatLogging,x:t.isDevelopment},t.isDevelopment?e.e({y:e.o((...e)=>h.fillTestPhone&&h.fillTestPhone(...e)),z:e.o((...e)=>h.mockWechatLogin&&h.mockWechatLogin(...e)),A:t.debugInfo},t.debugInfo?{B:e.t(t.debugInfo)}:{}):{},{C:e.o((...e)=>h.showPrivacyPolicy&&h.showPrivacyPolicy(...e)),D:e.o((...e)=>h.showPrivacyPolicy&&h.showPrivacyPolicy(...e))})}],["__scopeId","data-v-71a31993"]]);wx.createPage(i);
