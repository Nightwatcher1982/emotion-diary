"use strict";const e=require("../../common/vendor.js"),n=require("../../utils/api.js"),t=e.defineComponent({__name:"index",setup(t){const o=e.ref(1),i=e.ref(!1),s=e.ref(0),a=e.reactive({text:"",emotions:[],intensity:5,scene:"",triggers:[],physicalSymptoms:[],copingMethods:[],enableDeepAnalysis:!1,deepAnswers:[]}),l=e.ref([{name:"快乐",icon:"😄",description:"愉悦、开心、满足"},{name:"焦虑",icon:"😟",description:"紧张、担心、不安"},{name:"愤怒",icon:"😡",description:"生气、愤怒、恼火"},{name:"悲伤",icon:"😢",description:"难过、沮丧、失落"},{name:"平静",icon:"😌",description:"放松、平和、宁静"},{name:"恐惧",icon:"😨",description:"害怕、恐慌、畏惧"}]),c=e.ref([{name:"工作",icon:"💼",description:"工作、职场、同事关系"},{name:"学习",icon:"📚",description:"学习、考试、学业压力"},{name:"生活",icon:"🏠",description:"日常生活、家庭、生活琐事"},{name:"社交",icon:"👥",description:"朋友聚会、社交活动"},{name:"健康",icon:"💊",description:"身体健康、医疗相关"},{name:"其他",icon:"🌟",description:"其他特殊情况"}]),r=e.ref(["工作压力","人际关系","身体不适","经济问题","学习困难","家庭矛盾","环境变化","时间压力","期望落空","沟通问题","决策困难","其他"]),d=e.ref(["心跳加速","胸闷气短","肌肉紧张","头痛头晕","失眠多梦","食欲变化","疲劳乏力","出汗颤抖","胃部不适","注意力难集中","无明显症状"]),p=e.ref(["深呼吸","运动锻炼","听音乐","倾诉交流","写日记","冥想放松","转移注意力","寻求帮助","积极思考","接受现状","暂时回避","其他方式"]),u=e.ref([{question:"这种情绪让你身体有什么反应？",options:["心跳加速","胸闷气短","肌肉紧张","头痛头晕","没有明显反应"]},{question:"你认为这种情绪主要由什么引起？",options:["具体事件","身体状态","他人行为","环境因素","无明显原因"]},{question:"面对这种情绪，你通常会？",options:["分析问题","寻求帮助","暂时回避","自我否定","接受现状"]},{question:"这种情绪对你的影响程度？",options:["严重影响日常","中等影响","轻微影响","基本无影响"]},{question:"你希望通过什么方式改善？",options:["运动锻炼","倾诉交流","专业帮助","自我调节","暂时不处理"]}]),m=e=>{a.text=e.detail.value},g=e=>{a.intensity=e.detail.value},v=e=>{a.enableDeepAnalysis=e.detail.value},h=()=>{o.value<4&&o.value++},y=()=>{o.value>1&&o.value--},x=()=>{a.enableDeepAnalysis=!a.enableDeepAnalysis},f=()=>{e.index.showToast({title:"语音输入功能开发中",icon:"none"})},w=()=>{a.enableDeepAnalysis?(a.deepAnswers=new Array(u.value.length).fill(void 0),i.value=!0,s.value=0):b()},A=()=>{s.value<u.value.length-1?s.value++:(_(),b())},S=()=>{s.value>0&&s.value--},_=()=>{i.value=!1},b=async()=>{if(!n.getToken())return e.index.showToast({title:"请先登录",icon:"none"}),void e.index.navigateTo({url:"/pages/login/index"});if(a.text.trim())if(0!==a.emotions.length)if(a.scene)try{e.index.showLoading({title:"保存中..."});const t={emotion_type:T(a.emotions[0]),intensity:a.intensity,scenario:M(a.scene),description:a.text,triggers:a.triggers.length>0?a.triggers:["手动记录"],physical_symptoms:a.physicalSymptoms.length>0?a.physicalSymptoms:[],coping_methods:a.copingMethods.length>0?a.copingMethods:["情绪记录"],people_involved:[],location:"",weather:"",effectiveness_rating:null,is_private:!1,enable_ai_analysis:a.enableDeepAnalysis};if(a.enableDeepAnalysis&&a.deepAnswers.length>0){const e=u.value.map((e,n)=>void 0!==a.deepAnswers[n]?`${e.question}: ${e.options[a.deepAnswers[n]]}`:null).filter(e=>Boolean(e));t.triggers=[...t.triggers,...e]}console.log("提交记录数据:",t);const o=await n.emotionAPI.createRecord(t);e.index.hideLoading(),e.index.showToast({title:"记录保存成功",icon:"success"}),j(),D(),setTimeout(()=>{a.enableDeepAnalysis?e.index.navigateTo({url:`/pages/analysis/index?recordId=${o.id}`}):e.index.switchTab({url:"/pages/index/index"})},1500)}catch(t){e.index.hideLoading(),console.error("保存记录失败:",t),e.index.showToast({title:(null==t?void 0:t.message)||"保存失败，请重试",icon:"none",duration:3e3})}else e.index.showToast({title:"请选择相关场景",icon:"none"});else e.index.showToast({title:"请选择至少一种情绪",icon:"none"});else e.index.showToast({title:"请输入情绪描述",icon:"none"})},D=()=>{a.text="",a.emotions=[],a.intensity=5,a.scene="",a.triggers=[],a.physicalSymptoms=[],a.copingMethods=[],a.enableDeepAnalysis=!1,a.deepAnswers=[],o.value=1,i.value=!1,s.value=0},T=e=>({"快乐":"happy","焦虑":"anxious","愤怒":"angry","悲伤":"sad","平静":"calm","恐惧":"fearful"}[e]||"happy"),M=e=>({"工作":"work","学习":"study","生活":"personal","社交":"social","健康":"health","其他":"other"}[e]||"personal"),q=()=>{const n={...a,currentStep:o.value,timestamp:Date.now()};e.index.setStorageSync("emotion_record_draft",n),e.index.showToast({title:"草稿已保存",icon:"success",duration:1500})},j=()=>{e.index.removeStorageSync("emotion_record_draft")};return e.onMounted(()=>{const n=getCurrentPages(),t=n[n.length-1],i=(null==t?void 0:t.options)||{};i.quickEmotion?(a.emotions=[i.quickEmotion],o.value=2):(()=>{try{const n=e.index.getStorageSync("emotion_record_draft");if(n&&n.timestamp){Date.now()-n.timestamp<864e5?e.index.showModal({title:"发现草稿",content:"检测到未完成的记录，是否继续编辑？",success:t=>{t.confirm?(Object.assign(a,n),o.value=n.currentStep||1,e.index.showToast({title:"草稿已恢复",icon:"success"})):e.index.removeStorageSync("emotion_record_draft")}}):e.index.removeStorageSync("emotion_record_draft")}}catch(n){console.log("加载草稿失败:",n)}})()}),(n,t)=>e.e({a:e.o(q),b:o.value>=1?1:"",c:o.value>=2?1:"",d:o.value>=2?1:"",e:o.value>=3?1:"",f:o.value>=3?1:"",g:o.value>=4?1:"",h:o.value>=4?1:"",i:1===o.value},1===o.value?{j:e.o([e=>a.text=e.detail.value,m]),k:a.text,l:e.t(a.text.length),m:e.o(f),n:e.o(h),o:!a.text.trim()}:{},{p:2===o.value},2===o.value?e.e({q:e.f(l.value,(n,t,o)=>({a:e.t(n.icon),b:e.t(n.name),c:e.t(n.description),d:n.name,e:a.emotions.includes(n.name)?1:"",f:e.o(e=>(e=>{const n=a.emotions.indexOf(e);n>-1?a.emotions.splice(n,1):a.emotions.push(e)})(n.name),n.name)})),r:a.emotions.length>0},a.emotions.length>0?{s:e.t(a.intensity),t:a.intensity,v:e.o(g)}:{},{w:e.o(y),x:e.o(h),y:0===a.emotions.length}):{},{z:3===o.value},3===o.value?{A:e.f(c.value,(n,t,o)=>e.e({a:e.t(n.icon),b:e.t(n.name),c:e.t(n.description),d:a.scene===n.name},(a.scene,n.name,{}),{e:n.name,f:a.scene===n.name?1:"",g:e.o(e=>{return t=n.name,void(a.scene=t);var t},n.name)})),B:a.enableDeepAnalysis,C:e.o(v),D:e.o(x),E:e.o(y),F:e.o(h),G:!a.scene}:{},{H:4===o.value},4===o.value?e.e({I:e.f(r.value,(n,t,o)=>({a:e.t(n),b:n,c:a.triggers.includes(n)?1:"",d:e.o(e=>(e=>{const n=a.triggers.indexOf(e);n>-1?a.triggers.splice(n,1):a.triggers.push(e)})(n),n)})),J:e.f(d.value,(n,t,o)=>({a:e.t(n),b:n,c:a.physicalSymptoms.includes(n)?1:"",d:e.o(e=>(e=>{const n=a.physicalSymptoms.indexOf(e);n>-1?a.physicalSymptoms.splice(n,1):a.physicalSymptoms.push(e)})(n),n)})),K:e.f(p.value,(n,t,o)=>({a:e.t(n),b:n,c:a.copingMethods.includes(n)?1:"",d:e.o(e=>(e=>{const n=a.copingMethods.indexOf(e);n>-1?a.copingMethods.splice(n,1):a.copingMethods.push(e)})(n),n)})),L:a.enableDeepAnalysis,M:e.o(v),N:e.o(x),O:e.t(a.text||"暂无"),P:e.t(a.emotions.join("、")||"暂无"),Q:e.t(a.intensity),R:e.t(a.scene||"暂无"),S:a.triggers.length>0},a.triggers.length>0?{T:e.t(a.triggers.join("、"))}:{},{U:a.physicalSymptoms.length>0},a.physicalSymptoms.length>0?{V:e.t(a.physicalSymptoms.join("、"))}:{},{W:a.copingMethods.length>0},a.copingMethods.length>0?{X:e.t(a.copingMethods.join("、"))}:{},{Y:e.o(y),Z:e.t(a.enableDeepAnalysis?"继续深度分析":"保存记录"),aa:e.o(w)}):{},{ab:i.value},i.value?e.e({ac:e.t(s.value+1),ad:e.t(u.value.length),ae:e.o(_),af:e.t(u.value[s.value].question),ag:e.f(u.value[s.value].options,(n,t,o)=>({a:e.t(n),b:t,c:a.deepAnswers[s.value]===t?1:"",d:e.o(e=>{return n=t,void(a.deepAnswers[s.value]=n);var n},t)})),ah:s.value>0},s.value>0?{ai:e.o(S)}:{},{aj:e.t(s.value===u.value.length-1?"完成分析":"下一题"),ak:e.o(A),al:void 0===a.deepAnswers[s.value]}):{})}}),o=e._export_sfc(t,[["__scopeId","data-v-de8e6dd4"]]);wx.createPage(o);
